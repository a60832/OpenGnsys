#!/bin/bash
###########################################################
#####librerias de Boot v0.0.8r5 para Advanced Deploy enViorenment###########
# Liberado bajo licencia GPL <http://www.gnu.org/licenses/gpl.html>################
############# 2008 Antonio Doblas Viso  adv@uma.es ##########################
########### Universidad de Malaga (Spain)############################
##########################################################
function moddhcpdconf () {
echo "Moding dhcpd.conf, for $1, from $2 to $3, at `date`"
sed < /etc/dhcp3/dhcpd.conf "s/^\(host $1 .*filename \"\)$2\(\".*\)$/\1$3\2/" > /tmp/dhcpd.conf.out
# mv /etc/dhcpd.conf.out /etc/dhcpd.conf
$DHCPD restart
rm -f /tmp/lockbackup
}



function InstalaGrub4dos {
if [ $# = 0 ]
then
	echo comentario: instala grub4dos en el MBR del disco indicado para arrancar el S.O. ubicado en el punto de montaje indicado. 
	echo sintaxis: Grub4dos </ubicacion MBR>/ </Label>/\n"
	echo ejemplos: Grub4dos /dev/hda /mnt/hda1/\n"
	echo ejemplo: grub4dos $disco0 Label
fi
PART=`MountPartition $1 $2`
sleep 2
cp -r ${REPO}/admin/gestion/grub/* $PART
# bootlace.com $1
#DesmontarParticion $2
}

function HDBoot {
if [ $# = 0 ]
then
	echo "sintaxis: HDBoot int_disk(1-9) int_partition(1-9)"
	echo "ejemplos: HDBoot 1 1"
fi
disco=`Disk $1 $2`
particion=`IdPartition $1 $2`
echo $disco $particion
#MountPartition $1 $2
#cp -r ${REPO}/admin/gestion/grub/* /mnt/$particion
#Msg "instalando grub2dos en $particion" red
#sleep 2
tipo=`TypeFS $1 $2`
case $tipo in
	NTFS)
                UmountPartition $1 $2;
                if ! [ `ntfsls $disco | grep grub.exe` ]
                then
			particion=`IdPartition $1 $2`
			Msg "inciando windows en $particion" red;
                        Msg "instalando grub2dos en $particion" red;
                        for i in `find /var/EAC/admin/gestion/grub/ -type f -name "*"`                     
                        do
                          comando="ntfscp $disco $i `GetLastStr $i /`"
                          $comando && echo "copiando desde $i"
                        done
                fi
		MountPartition $1 $2
                Msg "inciando windows en $particion" red;
		kexec -l /mnt/${particion}/grub.exe --append=--config-file="find --set-root /ntldr; chainloader /ntldr";
		#kexec --debug  -l /mnt/${particion}/grub.exe --append=--config-file="find --set-root /ntldr; chainloader /ntldr";
        ;;
        EXT*|CACHE)
		Msg "inciando linux en $particion" red;
		kexec -l /mnt/${particion}/grub.exe --append=--config-file="find --set-root /sbin/init; configfile /boot/grub/menu.lst";;	
		# kexec -l /mnt/${particion}/grub.exe;;
	esac
kexec -e
}

function BootLinuxEX {
MountPartition
kexec -l /mnt/sda3/boot/vmlinuz-2.6.24-16-generic --initrd=/mnt/sda3/boot/initrd.img-2.6.24-16-generic --append="root=/dev/sda3 ro quiet aplash"
kexec -e
}

function SetDefaultBoot {
if [ $# = 2 ]
then
	processtart=`WhatsTime`
	${REPO}/admin/procedimientos/TareasServidor.php SetDefaultBoot $1 $2
	parametros="$*"
	howlong=`HowLongHasWorked $processtart`
	${REPO}/admin/procedimientos/Log "$IP" "$howlong" "SetDefaultBoot" "$parametros" 
else 
	Msg "error de sintaxis: SetDefaultBoot labelBoot \$IP" red
	Msg "ejemplos de label: pxe  1   11  12   21" red
return
fi
}




function ConvertToGrub() {
if [ $# = 0 ]
then
	echo comentario: Convierte la sintaxis de EAC en sintaxis grub. 
	echo sintaxis: ConvertToGrub int_disco int_particion
	echo ejemplos: ConvertToGrub 1 1
	echo ejemplo: ConvertToGrub 1
fi
if [ $# = 1 ]
then
	echo $1 | awk '{print "(hd" $1-1")"}'
fi
if [ $# = 2 ]
then
	echo $* | awk '{print "(hd" $1-1"," $2-1")"}'
fi
}


function InstallGrub () {
if [ $# != 3 ]
then
	Msg "instala el grub en MBR o en PARTITION, se debe indicar con el 2 y 3 paratemetos la particion donde esta la segunda etapa del grub" blue
	Msg "sintaxis Install to MBR: InstallGrub str_FirstStage int_disk_SecondStage int_partition_SecondStage" red
	Msg "ejemplo to MBR: InstallGrub MBR 1 1" red
	Msg "ejemplo to PARTITION: InstallGrub PARTITION 1 3" red
	return
fi
rm /tmp/instruccionesGrub
touch /tmp/instruccionesGrub
case $1 in
	"MBR")
		place=`ConvertToGrub $2`;
		rootpartition=`ConvertToGrub $2 $3`;
		mensaje="instalando la primera etapa en $place y la segunda etapa en $rootpartition"
cat >> /tmp/instruccionesGrub <<EOF
root ${rootpartition};
setup ${place};
quit
EOF
	;;
	"PARTITION")
		placeandrootpartition=`ConvertToGrub $2 $3`;
		mensaje="instalando la primera y segunda etapa del grub en la misma particion: $placeandrootpartition"
cat >> /tmp/instruccionesGrub <<EOF
root ${placeandrootpartition};
setup ${placeandrootpartition};
quit
EOF
	;;
	*)
	;;
esac
grub < /tmp/instruccionesGrub
Msg "$mensaje" orange
rm /tmp/instruccionesGrub
}

function ConfGrub () {
if [ $# != 2 ]
then
	Msg "Configura el stage 2 del grub, hay que indicar int_disk int_partition" blue
	Msg "sintaxis ConfGrub int_disk int_partition" red
	return
fi
PARTGRUB=`MountPartition $1 $2`	
DISPGRUB=/dev/`IdPartition $1 $2`
PARTROOT=`ConvertToGrub $1 $2`

Msg "procediendo a configurar la segunda etapa del grub. situada en $DISPGRUB y montada en $PARTGRUB" red
	echo " " > ${PARTGRUB}/boot/grub/menu.lst
	if NTDetect 1
	then
		Msg "ntdetec debe devolver un valor para \$WINDOWS =$Windows y otro para \$SystemRoot = $SystemRoot " red
		WINROOT=`ConvertToGrub $Windows` 
		Msg "procediendo a configurar la segunda etapa del grub. situada en $DISPGRUB y montada en $PARTGRUB" red
		echo "title Windows en $Windows " >> ${PARTGRUB}/boot/grub/menu.lst 
		echo "root $WINROOT" >> ${PARTGRUB}/boot/grub/menu.lst 
		echo "makeactive" >> ${PARTGRUB}/boot/grub/menu.lst 
		echo "chainloader +1" >> ${PARTGRUB}/boot/grub/menu.lst
	fi
	Msg "procediendo a configurar la segunda etapa del grub. situada en $DISPGRUB y montada en $PARTGRUB" red
	echo "title Rescue Partition Advanced Deploy enViorenment in ${DISPGRUB}" >> ${PARTGRUB}/boot/grub/menu.lst
	echo "root $PARTROOT" >> ${PARTGRUB}/boot/grub/menu.lst
	echo "kernel /boot/`ls ${PARTGRUB}/boot/ | grep vmlinuz` root=${DISPGRUB} ro status=EACrescueHD"  >> ${PARTGRUB}/boot/grub/menu.lst
	echo "initrd /boot/`ls ${PARTGRUB}/boot/ | grep initrd.img | awk '! /.bak/ {print $1}' | awk 'NF == 1 {print $1}'`" >> ${PARTGRUB}/boot/grub/menu.lst
	echo "title arrancar desde floppy" >> ${PARTGRUB}/boot/grub/menu.lst
	echo "root (fd)" >> ${PARTGRUB}/boot/grub/menu.lst
	echo "chainloader +1" >> ${PARTGRUB}/boot/grub/menu.lst
	unset PARTGRUB
	unset DISPGRUB
}


