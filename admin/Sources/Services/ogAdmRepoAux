#!/bin/bash
PARM=`cat`

#TODO:  ticket 379
#buscar parametro de identificador de operacion.
#usar parametro de identificacion para anexarlo al nombre de log
#Comprobar si la variable está seteas.
#Si no lo está setearla.
#Si esta seteada (en progreso) salir.



BASEDIR=/opt/opengnsys
PATH=$PATH:$BASEDIR/bin
REPONAME=ogAdmRepo
REPOLOG=$BASEDIR/log/$REPONAME.log
MCASTLOGBASE=$BASEDIR/log/mcastlog
MCASTLOG=$MCASTLOGBASE/ogAdmRepoMcast.`date +%Y%m%d-%H%M%S`

# Añade registro de incidencias.
function echolog () {
	date +"%Y%m%d-%H%M%S $*" >> $REPOLOG
}

mkdir -p $MCASTLOGBASE

PARM1=$(echo $PARM | cut -f1 -d" ")
PARM2=$(echo $PARM | cut -f2 -d" ")
PARM3=$(echo $PARM | cut -f3 -d" ")
PARM4=$(echo $PARM | cut -f4 -d" ")


case "$PARM1" in
	START_MULTICAST)
		#1 START_MULTICAST
		#2 fichero a enviar
		#3 opciones de multicast
		FILE="$PARM2"
		MCASTOPT="$PARM3"
		echolog "Ejecutar $(which sendFileMcast) $FILE $MCASTOPT"
		sendFileMcast $FILE $MCASTOPT &>> $MCASTLOG
		case $? in
			1)  echolog "Parametros insuficientes"
			    return 1 ;;
			2)  echolog "Fichero no accesible"
			    return 2 ;;
			3)  echolog "Sesion multicast no valida"
			    return 3 ;;
		esac
	;;
	default)
	    echolog "Solicitud con parametros  \"$PARM\"  no realizada, no registrada o con errores"
	;;
esac

