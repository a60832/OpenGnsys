#!/bin/bash
#_______________________________________________________________________________________________________________________________
#
# PARAMETROS RECIBIDOS DESDE EL CLIENTE:
# $1 disco
# $2 par=N�mero de particion
# $3 Nombre can�nico de la imagen
# $4 Direcci�n IP del repositorio
# $5 Protocolo  UNICAST  MULTICAST  TORRENT
# $6 Opciones del protocolo
#_______________________________________________________________________________________________________________________________

#Descripcion:
# La interfaz detecta:
#    Si Repositorio es el global (REPO) realiza un deploy.
#    Si Repositorio es local (CACHE) realiza un ogRestoreImage CACHE
# El deploy, si detecta que el cliente no tiene una cache con espacio suficiente reazlia un ogRestore REPO

#Códigos de error de ogRestoreImage
#@exception OG_ERR_FORMAT   1 formato incorrecto.
#@exception OG_ERR_NOTFOUND  2 fichero de imagen o partición no detectados.
#@exception OG_ERR_PARTITION 3	# Error en partición de disco.
#@exception OG_ERR_LOCKED    4 partición bloqueada por otra operación.
#@exception OG_ERR_IMAGE    5 error al restaurar la imagen del sistema.
#@exception OG_ERR_IMGSIZEPARTITION  30 Tamaño de la particion es menor al tamaño de la imagen.
#@todo: el scripts restoreImage limitarlo a origen:fichero destino:particion
#@version 1.0.1 - Separación en protocolos de transferencia y postconfiguracion
#@author  Antonio J. Doblas Viso. Universidad de Málaga
#@date   2011-05-11
#@version 1.0.1 - Separación de los ficheros-log para ser gestionado por el httpd-log
#@author Antonio J. Doblas Viso. Universidad de Málaga  
#@date   2011-05-11


echo " " > $OGLOGSTANDAR
echo " " > $OGLOGTRACK

# Registro de ejecución
echo $* >> $OGLOGSTANDAR
echo "$*" &>> $OGLOGSTANDAR | $(tail -n 1 $OGLOGSTANDAR >> $OGLOGFILE)


# Si el origen(pariticion) esta bloqueada salir.

echo "TODO comprobando si esta bloqueado el $1 $2" &>> $OGLOGSTANDAR
#if ogIsLocked $1 $2; then
#	ogRaiseError $OG_ERR_LOCKED "$MSG_PARTITION, $1 $2"
#	exit $?
#fi

# Valor por defecto para el repositorio.
REPO=${4:-"REPO"}
[ "$REPO" == "$(ogGetRepoIp)" ] && REPO="REPO"
[ "$REPO" == "$(ogGetIpAddress)" ] && REPO="CACHE"
[ "$REPO" == "CACHE" ] && REPO="CACHE"


if [ "$REPO" == "CACHE" ] 
then
	echo "[1] Iniciando un ogRestoreImage CACHE /$3 $1 $2" &>> $OGLOGSTANDAR
	ogRestoreImage CACHE /"$3" "$1" "$2" &>> $OGLOGTRACK
	RETVAL=$?
fi	



if [ "$REPO" == "REPO" ]
then
	echo "[1] updateCache REPO /$3.img $5 $6"	 &>> $OGLOGSTANDAR 
	updateCache REPO /$3.img $5 $6	 &>> $OGLOGTRACK	
	RETVAL=$?
	case $RETVAL in
		0) 
		 echo "[50] updateCache (correcto)" &>> $OGLOGSTANDAR
		 echo "[55] Restaurando la imagen desde la cache con comando: ogRestoreImage CACHE /$3 $1 $2 UNICAST" &>> $OGLOGSTANDAR
		 ogRestoreImage CACHE /"$3" "$1" "$2" &> $OGLOGTRACK
		RETVAL=$? 
		;;
		15)
		echo "[50] updateCache(no hay CACHE); se realiza ogRestoreImage REPO /$3 $1 $2 UNICAST"  &>> $OGLOGSTANDAR
		echo "[55] Se restaura la imagen directamente desde el REPO: ogRestoreImage REPO /$3 $1 $2 UNICAST"  &>> $OGLOGSTANDAR
		ogRestoreImage REPO /"$3" "$1" "$2" &>> $OGLOGTRACK
		RETVAL=$? 		
		;;
		16)
		echo "[50] updateCache(no hay espacio sufiente en la CACHE), Se realiza ogRestoreImage REPO /$3 $1 $2 UNICAST"  &>> $OGLOGSTANDAR
		ogRestoreImage REPO /"$3" "$1" "$2" &>> $OGLOGTRACK
		RETVAL=$? 
		;;
	esac		
fi

if [ $RETVAL == 0 ]
then
	echo "[90] Iniciando la Configuracion del Sistema Restaurado" &>> $OGLOGSTANDAR
	configureOs $1 $2 &>> $OGLOGTRACK
fi
#if [ $RETVAL == 0 ]
#then
#	rm $OGLOGFILE
#	touch $OGLOGFILE
#else
#	echo $RETVAL &>> $OGLOGFILE
#fi
exit $RETVAL
