#!/bin/bash
#/**
#@file    Disk.lib
#@brief   Librería o clase Disk
#@class   Disk
#@brief   Funciones para gestión de discos y particiones.
#@version 0.9
#@warning License: GNU GPLv3+
#*/

#/**
#         ogDiskToDev [int_ndisk [int_npartition]]
#@brief   Devuelve la equivalencia entre el nº de orden del dispositivo (dicso o partición) y el nombre de fichero de dispositivo correspondiente.
#@arg  \c ndisk:      nº de orden del disco
#@arg  \c npartition: nº de orden de la partición
#@return  Para 0 parametros: Devuelve los nombres de ficheros  de los dispositivos sata/ata/usb linux encontrados.
#@return  Para 1 parametros: Devuelve la ruta del disco duro indicado.
#@return  Para 2 parametros: Devuelve la ruta de la particion indicada.
#@exception OG_ERR_FORMAT   Formato incorrecto.
#@exception OG_ERR_NOTFOUND Dispositivo no detectado.
#@note    Primera versión para OpenGNSys
#@author  Ramon Gomez, ETSII Universidad Sevilla
#@date    2009-07-20
#*/
function ogDiskToDev () {

#/// Variables locales
local DISCOS DISCO PART         #/// Variables locales

#/// Listar dispositivo para los discos duros (tipos: 3=hd, 8=sd).
DISCOS=$(awk '($1==3 || $1==8) && $4!~/[0-9]/ {printf "/dev/%s ",$4}' /proc/partitions)

#/// Mostrar salidas segun el número de parametros.
case $# in
     0) # Muestra todos los discos, separados por espacios.
	echo "$DISCOS"
	;;
     1) # Error si el parametro no es un digito.
	[ -n "${1/[1-9]/}" ] && (ogRaiseError $OG_ERR_FORMAT; return $?)
	DISCO=$(echo $DISCOS | awk -v n=$1 '{print $n}')
	# Error si no es fichero de bloques.
	[ -b "$DISCO" ] || (ogRaiseError $OG_ERR_NOTFOUND "$1"; return $?)
	echo "$DISCO"
	;;
     2) # Error si los 2 parametros no son digitos.
	[ -n "${1/[1-9]/}" -o -n "${2/[1-9]/}" ] && (ogRaiseError $OG_ERR_FORMAT; return $?)
	PART=$(echo $DISCOS | awk -v n=$1 '{print $n}')$2
	# Error si no es fichero de bloques.
	[ -b "$PART" ] || (ogRaiseError $OG_ERR_NOTFOUND "$1 $2"; return $?)
	echo "$PART"
	;;
     *) # Formato erroneo.
	ogRaiseError $OG_ERR_FORMAT; return $?
esac
}


#/**
#         ogGetPartitionId int_ndisk int_npartition
#@brief   Devuelve el mnemonico con el tipo de sistema de archivos.
#@arg  \c ndisk:      nº de orden del disco
#@arg  \c npartition: nº de orden de la partición
#@return  Identificador de tipo de partición.
#@exception OG_ERR_FORMAT Formato incorrecto.
#@exception OG_ERR_NOTFOUND Disco o particion no corresponden con un dispositivo.
#@version 0.9 - Primera versión compatible con OpenGNSys.
#@author  Ramon Gomez, ETSII Universidad de Sevilla
#@date    25/03/2009
#*/
function ogGetPartitionId () {

#/// Variables locales.
local DISK PART         #/// Variables locales.

#/// Error si no se reciben 2 parametros.
[ $# != 2 ] && ogRaiseError $OG_ERR_FORMAT

#/// Detectar id. de tipo de particion y codificar al mnemonico.
DISK=$(ogDiskToDev $1) || return $?
PART=$(ogDiskToDev $1 $2) || return $?
echo $(sfdisk --id $DISK $2 2>/dev/null)
}

