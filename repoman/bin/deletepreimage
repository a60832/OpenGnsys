# Eliminar las imagenes del repositiro seg�raca de la consola web .img
#Version 0.3   Ejecuci�n desde cron cada minuto,o.
#echo "* * * * *   root   /opt/opengnsys/bin/image-delete" > /etc/cron.d/imagedelete

# Comprobar si el proceso ya est� en ejecuci�n.on.
PROG=$(basename $0)
[ "$(pgrep "$PROG")" != "$$" ] && exit

# Variables.
OPENGNSYS=${OPENGNSYS:-"/opt/opengnsys"}
PATH=$PATH:$OPENGNSYS/bin
OGIMG="$OPENGNSYS/images"
REPOCFG="$OPENGNSYS/etc/ogAdmRepo.cfg"
LOGFILE="$OPENGNSYS/log/$PROG.log"

# Error si no est� bien configurado el repositorio de im�genes.nes.
[ -d $OGIMG -a -f $REPOCFG ] || exit 1

# Procesar ficheros de im�genes.s.
trap 'echo "`date` : Proceso interrumpido" >> $LOGFILE; exit ' 1 2 3 6 9 15

#TODO en LOCAL: si existe algun fichero *.delete lo movemos al repositorio
ls /opt/opengnsys/www/tmp/*.delete &>/dev/null || exit
#[ -f /opt/opengnsys/www/tmp/*.delete ] && 
mv /opt/opengnsys/www/tmp/*.* /opt/opengnsys/images/

#TODO: iniciar blucle siempre y cuando haya algun delete
ls /opt/opengnsys/images/*.delete &>/dev/null || exit

for IMG in `ls /opt/opengnsys/images/*.delete`; do
        DELETEIMAGE=$(echo $IMG | awk -F"." '{print $1}' | awk -F"/opt/opengnsys/images/" '{print $2}')
        # Borramos marca .delete para que el proximo cron no trabaje sobre este conjunto.
        [ -f  $IMG ] &&  rm $IMG
        ## se llama al escript de borrado de imagen.
        /opt/opengnsys/bin/deleteimage $DELETEIMAGE
done
