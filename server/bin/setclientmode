#!/bin/bash
# setclientmode: Configura el archivo de arranque de PXE para los clientes,
#	ya sea un equipo o un aula, generando enlaces a archivos usados como plantilla. 
# Nota: El archivo PXE por defecto "default" se deja en modo de ejecución "user" 
#	y se eliminan los enlaces para equipos con la plantilla por defecto.
# Uso:	clienmode NombrePlatilla { NombrePC | NombreAula }
# Autores: Irina Gomez y Ramon Gomez - Univ. Sevilla, noviembre 2010


# Variables.
PROG=$(basename $0)
OPENGNSYS=${OPENGNSYS:-"/opt/opengnsys"}
SERVERCONF=$OPENGNSYS/etc/ogAdmServer.cfg
PXEDIR=$OPENGNSYS/tftpboot/menu.lst
TEMPLATE="$PXEDIR/templates/$1"
LOGFILE=$OPENGNSYS/log/opengnsys.log
MYCNF=/tmp/.my.cnf.$$

# Control básico de errores.
if [ $# -ne 2 ]; then
	echo "$PROG: Error de ejecución"
	echo "Formato: $PROG Archivo_platilla [NOMBRE_PC|NOMBRE_AULA]"
	exit 1
fi
if [ ! -r $SERVERCONF ]; then
	echo "$PROG: Sin acceso a fichero de configuración"
	exit 2
fi
if [ ! -e $TEMPLATE ]; then
	echo "No existe archivo platilla: $TEMPLATE"
	exit
fi

# Obtener datos de acceso a la Base de datos.
source $SERVERCONF
# Sustituir caracteres ' por \' para evitar inyección SQL.
BOOTMODE="${1//\'/\'}"
RESOURCE="${2//\'/\'}"
# Componer fichero con credenciales de conexión. 
touch $MYCNF 
chmod 600 $MYCNF 
cat << EOT > $MYCNF 
[client] 
user=$USUARIO 
password=$PASSWORD 
EOT
# Borrar el fichero temporal si termina el proceso. 
trap "rm -f $MYCNF" 0 1 2 3 6 9 15 
# Buscar ordenador individual o todos los de una aula.
ETHERNET=$(mysql --defaults-file=$MYCNF -D "$CATALOG" -s -N -e \
		"SELECT mac FROM ordenadores 
 		   JOIN aulas USING (idaula) 
 		  WHERE aulas.nombreaula='$RESOURCE' 
 		     OR nombreordenador='$RESOURCE';")
if [ -z "$ETHERNET" ]; then
	date +"%b %d %T $PROG: No existe aula o equipo con el nombre \"$2\"" | tee -a $LOGFILE
	exit 1
fi

# Copiar fichero de configuración y actualizar base de datos.
date +"%b %d %T $PROG: Configurando \"$1\" en \"$2\"" | tee -a $LOGFILE
NPC=0
for MAC in $ETHERNET; do
	date +"%b %d %T $PROG: Detectada ethernet \"$MAC\" en \"$2\"" | tee -a $LOGFILE
	# Si existe anteriormente el fichero PXE, lo borra
	PXEFILE=$PXEDIR/01-${MAC:0:2}-${MAC:2:2}-${MAC:4:2}-${MAC:6:2}-${MAC:8:2}-${MAC:10:2}
	[ -e $PXEFILE ] && rm $PXEFILE
	if [ "$1" != "default" ]; then
		# Si no está definida la variable LANG, usar idioma inglés por defecto.
		[ -z "$LANG" -o "$LANG" == "C" ] && LANG="en"
		# Obtener de la BD los parámetros de arranque asociados (separador es TAB).
		DATOS=$(mysql --defaults-file=$MYCNF -D "$CATALOG" -s -N -e \
			"SELECT ' LANG=$LANG',
				' ip=', CONCAT_WS (':', ordenadores.ip,
				(@repoip:=repositorios.ip), aulas.router, aulas.netmask,
				ordenadores.nombreordenador, ordenadores.netiface, 'none'),
				' group=', REPLACE (aulas.nombreaula, ' ', '_'),
				' ogrepo=', @repoip,
				' oglive=', @repoip,
				' oglog=', (SELECT (@serverip:=ipserveradm) FROM entornos LIMIT 1),
				' ogshare=', @serverip,
				' winboot=', IFNULL (perfileshard.winboot, 'reboot'),
				IF (menus.resolucion IS NULL, '', CONCAT (' video=', menus.resolucion))
				FROM ordenadores 
				JOIN aulas USING (idaula)
				JOIN repositorios USING (idrepositorio)
				LEFT JOIN perfileshard USING (idperfilhard)
				LEFT JOIN menus USING (idmenu)
				WHERE ordenadores.mac='$MAC';")
		# Quitar tabuladores y sustituir caracteres quitando acentos y tildes.
		DATOS=$(echo ${DATOS//	/} | tr 'áéíóúñÁÉÍÓÚÑ' 'aeiounAEIOUN')
		# Crear fichero PXE a partir de la plantilla con los datos obtenidos en la BD.
		sed -e "s/vga=[0-9]*//g; s/INFOHOST/$DATOS/g" $TEMPLATE >$PXEFILE
		# Actualizar en la BD el modo de arranque asociada el cliente.
		mysql --defaults-file=$MYCNF -D "$CATALOG" -e \
			"UPDATE ordenadores SET arranque='$BOOTMODE' WHERE mac='$MAC';"
	fi
	let NPC=NPC+1
done
date +"%b %d %T $PROG: $NPC equipo(s) configurado(s)" | tee -a $LOGFILE

