#!/bin/bash
# setclientmode: Configura el archivo de arranque de PXE para los clientes,
#	ya sea un equipo o un aula, generando enlaces a archivos usados como plantilla. 
# Nota: El archivo PXE por defecto "default" se deja en modo de ejecución "user" 
#	y se eliminan los enlaces para equipos con la plantilla por defecto.
# Uso:	clienmode NombrePlatilla { NombrePC | NombreAula }
# Autores: Irina Gomez y Ramon Gomez - Univ. Sevilla, noviembre 2010


# Variables.
PROG=$(basename $0)
OPENGNSYS=${OPENGNSYS:-"/opt/opengnsys"}
SERVERCONF=$OPENGNSYS/etc/ogAdmServer.cfg
PXEDIR=$OPENGNSYS/tftpboot/menu.lst
TEMPLATE="$PXEDIR/templates/$1"
LOGFILE=$OPENGNSYS/log/opengnsys.log

# Control básico de errores.
if [ $# -ne 2 ]; then
	echo "$PROG: Error de ejecución"
	echo "Formato: $PROG Archivo_platilla [NOMBRE_PC|NOMBRE_AULA]"
	exit 1
fi
if [ ! -r $SERVERCONF ]; then
	echo "$PROG: Sin acceso a fichero de configuración"
	exit 2
fi
if [ ! -e $TEMPLATE ]; then
	echo "No existe archivo platilla: $TEMPLATE"
	exit
fi

# Obtener datos de acceso a la Base de datos.
source $SERVERCONF
# Sustituir caracteres ' por \' para evitar inyección SQL.
BOOTMODE="${1//\'/\'}"
RESOURCE="${2//\'/\'}"
# Comprobar si se recibe nombre de aula o de equipo.
IDAULA=$(mysql -u "$USUARIO" -p"$PASSWORD" -D "$CATALOG" -s -N -e \
		"SELECT idaula FROM aulas WHERE nombreaula='$RESOURCE';")

if [ -n "$IDAULA" ]; then
	# Aula encontrada
	ETHERNET=$(mysql -u "$USUARIO" -p"$PASSWORD" -D "$CATALOG" -s -N -e \
        	"SELECT mac FROM ordenadores WHERE idaula='$IDAULA';")
else
	# Buscar ordenador
	ETHERNET=$(mysql -u "$USUARIO" -p"$PASSWORD" -D "$CATALOG" -s -N -e \
        	"SELECT mac FROM ordenadores WHERE nombreordenador='$RESOURCE';")
fi
if [ -z "$ETHERNET" ]; then
	date +"%b %d %T $PROG: No existe aula o equipo con el nombre \"$2\"" | tee -a $LOGFILE
	exit 1
fi

# Copiar fichero de configuración y actualizar base de datos.
date +"%b %d %T $PROG: Configurando \"$1\" en \"$2\"" | tee -a $LOGFILE
NPC=0
for AUX in $ETHERNET; do
	date +"%b %d %T $PROG: Detectada ethernet \"$AUX\" en \"$2\"" | tee -a $LOGFILE
	AUX="01-${AUX:0:2}-${AUX:2:2}-${AUX:4:2}-${AUX:6:2}-${AUX:8:2}-${AUX:10:2}"
	# Si existe anteriormente lo borra
	[ -e $PXEDIR/$AUX ] && rm $PXEDIR/$AUX
	if [ "$1" != "default" ]; then
		# Si no está definida la variable LANG, usar idioma inglés por defecto.
		[ -z "$LANG" -o "$LANG" == "C" ] && LANG="en"
		# Obtener de la BD los parámetros de arranque asociados (separador es TAB).
		DATOS=$(mysql -u "$USUARIO" -p"$PASSWORD" -D "$CATALOG" -s -N -e \
			"SELECT ' LANG=$LANG',
				' ip=', CONCAT_WS (':', ordenadores.ip,
				(@repoip:=repositorios.ip), aulas.router, aulas.netmask,
				ordenadores.nombreordenador, ordenadores.netiface, 'none'),
				' group=', REPLACE (aulas.nombreaula, ' ', '_'),
				' ogrepo=', @repoip,
				' oglive=', @repoip,
				' oglog=', (SELECT (@serverip:=ipserveradm) FROM entornos LIMIT 1),
				' ogshare=', @serverip,
				' winboot=', IFNULL (perfileshard.winboot, 'reboot'),
				IF (menus.resolucion IS NULL, '', CONCAT (' video=', menus.resolucion))
				FROM ordenadores 
				JOIN aulas USING (idaula)
				JOIN repositorios USING (idrepositorio)
				LEFT JOIN perfileshard USING (idperfilhard)
				LEFT JOIN menus USING (idmenu)
				WHERE ordenadores.mac='$ETHERNET';")
		# Quitar tabuladores y sustituir caracteres quitando acentos y tildes.
		DATOS=$(echo ${DATOS//	/} | tr 'áéíóúñÁÉÍÓÚÑ' 'aeiounAEIOUN')
		# Crear fichero PXE a partir de la plantilla con los datos obtenidos en la BD.
		sed -e "s/vga=[0-9]*//; s/INFOHOST/$DATOS/" $TEMPLATE >$PXEDIR/$AUX
		# Actualizar en la BD el modo de arranque asociada el cliente.
		mysql -u "$USUARIO" -p"$PASSWORD" -D "$CATALOG" -e \
			"UPDATE ordenadores SET arranque='$BOOTMODE' WHERE mac='$ETHERNET';"
	fi
	let NPC=NPC+1
done
date +"%b %d %T $PROG: $NPC equipo(s) configurado(s)" | tee -a $LOGFILE

